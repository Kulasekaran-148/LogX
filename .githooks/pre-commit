#!/bin/bash
# Pre-commit hook: format only misformatted C/C++ files using clang-format

# Get list of staged C/C++ files (Added, Copied, or Modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|h|hpp)$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "üîç Checking C/C++ formatting..."

HAS_CHANGES=0

for file in $STAGED_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    # Compare current file with clang-format output
    diff_output=$(diff -u <(cat "$file") <(clang-format "$file"))
    if [ -n "$diff_output" ]; then
        echo "‚öôÔ∏è  Reformatting: $file"
        clang-format -i "$file"
        git add "$file"
        HAS_CHANGES=1
    fi
done

if [ $HAS_CHANGES -eq 1 ]; then
    echo "‚úÖ Code formatted. Re-added to commit."
else
    echo "‚ú® All files already well-formatted."
fi

exit 0
